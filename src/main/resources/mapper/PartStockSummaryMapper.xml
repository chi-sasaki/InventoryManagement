<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.InventoryManagement.repository.PartStockSummaryMapper">

    <!-- 指定された期間の部品の集計結果を取得します -->
    <select id="findSummaryByPeriod"
            resultType="com.example.InventoryManagement.dto.PartStockSummary">

        SELECT
        p.id AS partId,
        pm.part_name AS partName,
        p.model_number AS modelNumber,

        COALESCE(SUM(
        CASE
        WHEN sh.quantity > 0 THEN sh.quantity
        ELSE 0
        END
        ), 0) AS totalIn,

        COALESCE(SUM(
        CASE
        WHEN sh.quantity &lt; 0 THEN ABS(sh.quantity)
        ELSE 0
        END
        ), 0) AS totalOut

        FROM part p
        LEFT JOIN part_master pm
        ON p.part_master_id = pm.id

        LEFT JOIN stock_history_part sh
        ON sh.part_id = p.id
        AND sh.action_at >= #{from}
        AND sh.action_at &lt; #{to}

        GROUP BY p.id, pm.part_name, p.model_number
        ORDER BY p.id

    </select>

    <!-- 指定された部品の入出庫履歴を登録します -->
    <insert id="insertHistory">
        INSERT INTO stock_history_part
        (part_id, quantity, action_at)
        VALUES
        (#{partId}, #{quantity}, #{actionAt})
    </insert>

    <!-- 指定された部品IDの入出庫履歴が既に存在するかを確認します -->
    <select id="existsHistoryByPartId" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM stock_history_part
        WHERE part_id = #{partId}
    </select>

</mapper>