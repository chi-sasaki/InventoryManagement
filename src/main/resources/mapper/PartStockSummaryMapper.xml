<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.InventoryManagement.repository.PartStockSummaryMapper">

    <!-- 指定された期間の部品の集計結果を取得します -->
    <select id="findSummaryByPeriod"
            resultType="com.example.InventoryManagement.dto.PartStockSummary">

        SELECT
        p.id AS partId,
        p.part_name AS partName,

        COALESCE(SUM(
        CASE
        WHEN sh.quantity > 0 THEN sh.quantity
        ELSE 0
        END
        ), 0) AS totalIn,

        COALESCE(SUM(
        CASE
        WHEN sh.quantity &lt; 0 THEN ABS(sh.quantity)
        ELSE 0
        END
        ), 0) AS totalOut

        FROM part p
        LEFT JOIN stock_history_part sh
        ON sh.part_id = p.id
        AND sh.action_at >= #{from}
        AND sh.action_at &lt; #{to}

        GROUP BY p.id, p.part_name
        ORDER BY p.id
    </select>

</mapper>